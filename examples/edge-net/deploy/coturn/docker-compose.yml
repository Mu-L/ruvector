version: '3.8'

# Edge-Net coturn TURN/STUN Server Deployment
# For NAT traversal in symmetric NAT environments
#
# Usage:
#   1. Copy .env.example to .env and configure
#   2. docker-compose up -d
#   3. Configure firewall rules (see README.md)
#
# Production checklist:
#   - Set strong TURN credentials
#   - Configure TLS certificates
#   - Set up proper firewall rules
#   - Enable rate limiting

services:
  coturn:
    image: coturn/coturn:4.6.2-alpine
    container_name: edge-net-coturn
    restart: unless-stopped
    network_mode: host  # Required for proper UDP handling

    # Alternative: Use bridge mode with explicit ports
    # ports:
    #   - "3478:3478/udp"      # STUN/TURN UDP
    #   - "3478:3478/tcp"      # STUN/TURN TCP
    #   - "5349:5349/tcp"      # TURN over TLS
    #   - "5349:5349/udp"      # TURN over DTLS
    #   - "49152-65535:49152-65535/udp"  # Relay ports

    volumes:
      # Configuration file
      - ./turnserver.conf:/etc/turnserver.conf:ro
      # TLS certificates (optional but recommended for production)
      - ./certs:/etc/coturn/certs:ro
      # SQLite database for user management (optional)
      - coturn-data:/var/lib/coturn

    environment:
      # These can be overridden in .env file
      - TURN_REALM=${TURN_REALM:-edge-net.local}
      - TURN_USER=${TURN_USER:-edgenet}
      - TURN_PASSWORD=${TURN_PASSWORD:-changeme}
      - EXTERNAL_IP=${EXTERNAL_IP:-detect-external-ip}
      - MIN_PORT=${MIN_PORT:-49152}
      - MAX_PORT=${MAX_PORT:-65535}

    # Health check
    healthcheck:
      test: ["CMD", "turnutils_uclient", "-T", "-u", "${TURN_USER:-edgenet}", "-w", "${TURN_PASSWORD:-changeme}", "127.0.0.1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Command with inline config (alternative to config file)
    command: >
      turnserver
      --listening-port=3478
      --tls-listening-port=5349
      --min-port=${MIN_PORT:-49152}
      --max-port=${MAX_PORT:-65535}
      --realm=${TURN_REALM:-edge-net.local}
      --user=${TURN_USER:-edgenet}:${TURN_PASSWORD:-changeme}
      --lt-cred-mech
      --fingerprint
      --no-multicast-peers
      --no-loopback-peers
      --no-stun-backward-compatibility
      --response-origin-only-with-rfc5780
      --stale-nonce=600
      --max-bps=0
      --total-quota=0
      --user-quota=0
      --log-file=stdout
      --verbose

    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # Optional: Monitoring with Prometheus metrics
  coturn-exporter:
    image: prom/statsd-exporter:v0.24.0
    container_name: edge-net-coturn-exporter
    restart: unless-stopped
    ports:
      - "9125:9125/udp"
      - "9102:9102"
    profiles:
      - monitoring
    depends_on:
      - coturn

  # Optional: Redis for horizontal scaling
  redis:
    image: redis:7-alpine
    container_name: edge-net-coturn-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    profiles:
      - scaling
    command: redis-server --appendonly yes

volumes:
  coturn-data:
    driver: local
  redis-data:
    driver: local

# Networks for non-host mode deployment
networks:
  default:
    name: edge-net-turn
    driver: bridge
